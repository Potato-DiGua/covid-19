<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js">
    </script>
    <script src="js/echarts.min.js"></script>

    <script src="js/world.js"></script>
    <script src="js/countryMap.js"></script>

    <title>疫情数据</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body style="background: #172c3c">
<div id="result"></div>
<div style="text-align: right;margin-right: 200px">
    <div class="btn wave right" id="currentBtn">现有确诊</div>
    <div class="btn wave right" id="sumBtn">累计确诊</div>
    <div class="btn wave right" id="deadBtn">死亡人数</div>
    <div class="btn wave right" id="curedBtn">治愈人数</div>
</div>
<div id="map" style="width: 95%;height:720px;margin: 0 auto;"></div>
<script>


    //初始化echarts
    var myChart = echarts.init(document.getElementById('map'));
    initChart();

    // 页面需引入jquery库
    let APIKEY = "1531150663469519b4bf4e6ba73a5e08"

    $(document).ready(function () {
        $.get("http://api.tianapi.com/txapi/ncovabroad/index?key=" + APIKEY,
            function (data, status) {
                // console.log(data);

                let currentData = [];
                let sumData = [];
                let deadData = [];
                let curedData = [];
                for (let i of data.newslist) {
                    currentData.push({"name": i.provinceName, "value": i.currentConfirmedCount});
                    sumData.push({"name": i.provinceName, "value": i.confirmedCount});
                    deadData.push({"name": i.provinceName, "value": i.deadCount});
                    curedData.push({"name": i.provinceName, "value": i.curedCount});

                }

                let countryArray = getCountryArray();

                for (let country of countryArray) {
                    if (!countryMap.hasOwnProperty(country)) {
                        currentData.push({"name": country, "value": 0});
                        sumData.push({"name": country, "value": 0});
                        deadData.push({"name": country, "value": 0});
                        curedData.push({"name": country, "value": 0});
                    } else {
                        let key = countryMap[country];
                        if (!currentData.hasOwnProperty(key)) {
                            currentData.push({"name": key, "value": 0});
                            sumData.push({"name": key, "value": 0});
                            deadData.push({"name": key, "value": 0});
                            curedData.push({"name": key, "value": 0});
                        }
                    }
                }
                let pieces1 = [{
                    lte: 0,
                    label: "0",
                    color: "#ffffff"
                }, {
                    min: 1,
                    max: 99,
                    color: "#ff9985"
                }, {
                    min: 100,
                    max: 999,
                    color: "#f57567"
                }, {
                    min: 1000,
                    max: 9999,
                    color: "#e64546"
                }, {
                    min: 10000,
                    max: 99999,
                    color: "#b80909"
                }, {
                    min: 100000,
                    label: "≥100000",
                    color: "#8A0808"
                }];

                refreshChart(currentData, "现有确诊",pieces1);

                $("#currentBtn").click(function () {
                    refreshChart(currentData, "现有确诊",pieces1)
                });

                $("#sumBtn").click(function () {
                    refreshChart(sumData, "累计确诊", pieces1)
                });
                $("#deadBtn").click(function () {
                    refreshChart(deadData, "死亡人数", [{
                        lte: 0,
                        label: "0",
                        color: "#ffffff"
                    }, {
                        min: 1,
                        max: 99,
                        color: "#868686"
                    }, {
                        min: 100,
                        max: 999,
                        color: "#6d6d6d"
                    }, {
                        min: 1000,
                        max: 9999,
                        color: "#5c5c5c"
                    }, {
                        min: 10000,
                        max: 99999,
                        color: "#343434"
                    }, {
                        min: 100000,
                        label: "≥100000",
                        color: "#232323"
                    }])
                });
                $("#curedBtn").click(function () {
                    refreshChart(curedData, "治愈人数", [{
                        lte: 0,
                        label: "0",
                        color: "#ffffff"
                    }, {
                        min: 1,
                        max: 99,
                        color: "#c2ffc2"
                    }, {
                        min: 100,
                        max: 999,
                        color: "#9cff91"
                    }, {
                        min: 1000,
                        max: 9999,
                        color: "#40ff30"
                    }, {
                        min: 10000,
                        max: 99999,
                        color: "#149000"
                    }, {
                        min: 100000,
                        label: "≥100000",
                        color: "#007d00"
                    }])
                });
            });
    });


    //获取地图上所有国家
    function getCountryArray() {
        let countryArray = [];

        for (let country of echarts.getMap("world").geoJson.features) {
            countryArray.push(country.properties.name);
        }
        return countryArray;
    }

    //异步刷新数据
    function refreshChart(data, title, pieces) {

        myChart.setOption({
            title: {
                text: "全球疫情数据-" + title
            },
            visualMap: {
                pieces: pieces
            },
            series: [
                {
                    name: title,
                    type: 'map',
                    mapType: 'world',
                    emphasis: {
                        label: {show: false}
                    },
                    nameMap: countryMap,
                    data: data
                }
            ]
        })
    }

    //生成图表
    function initChart() {
        option = {
            title: {
                text: "全球疫情数据",
                left: "center",
                textStyle: {
                    color: "#ffffff"
                }
            },

            textStyle: {
                color: "#ffffff"
            },
            visualMap: {
                type: "piecewise",
                textStyle: {
                    color: "#ffffff"
                }
            },
            tooltip: {
                textStyle: {
                    color: "#ffffff"
                }
            }
        };
        myChart.setOption(option);

    }

</script>
</body>
</html>